<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>如何被写进恐怖故事里 · 结果页</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.dom.min.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#ffecec;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    canvas { display:block; }
  </style>
</head>
<body>

<script>
/* ========= 读取答题结果，选故事键 ========= */
const payload = (()=>{ try { return JSON.parse(localStorage.getItem('quizPayload')||'{}'); } catch(e){ return {}; } })();
const nameValue = payload.name || '参与者';
const ans = payload.answers || {};
let aHit=null; for(let i=1;i<=6;i++){ if(ans['AA'+i]==='是'){ aHit='A'+i; break; } }
let bHit=null; for(let i=1;i<=6;i++){ if(ans['B'+i]==='是'){ bHit='B'+i; break; } }
const cHit = ans['C1'] ? 'C1' : null;

let storyKey=null, storyLabel='';
if(bHit && cHit){ storyKey=bHit; storyLabel='焦虑原型 '+bHit; }
else if(aHit){ storyKey=aHit; storyLabel='身份原型 '+aHit; }
else if(bHit){ storyKey=bHit; storyLabel='焦虑原型 '+bHit; }
else if(cHit){ storyKey=cHit; storyLabel='伪归类 C1'; }
</script>

<!-- ========= 故事模板：合法 JSON，不会再把页面“撑成代码” ========= -->
<script type="application/json" id="story-templates">
{
  "A1": "她第一次来我们办公室的时候，大家都说她很有礼貌，说话轻声细语，穿着合身，笑起来像谁都不会拒绝的人。\\n领导很喜欢她，说她“像我们这行该有的样子”。她从不迟到，桌子永远整整齐齐，午饭吃得不多，话也不多。\\n有时候我偷偷看她自拍：角度永远一样，下巴朝镜头对齐，[A1a特征]，[A1c特征]。\\n她和谁都处得很好，只是没人见过她真正生气，或者真正开心。她每一次笑都像是按下某种按钮才启动的。[A1b特征]。\\n有天晚上我们加班，办公室只剩我和她。我走过去想问她要不要一起走，结果看到她正在镜子前低头调整什么。不是妆容，不是衣领——是脸。\\n她把脸从脸上慢慢剥下来，从额头撕开，再一寸一寸地卷到下巴。里面是空的。只有白白的塑料架子，像模特头。\\n她回头的时候，那张脸正挂在手里，可她还在笑。和照片里一模一样的笑。",
  "A2": "", "A3": "", "A4": "", "A5": "", "A6": "",
  "B1": "", "B2": "", "B3": "", "B4": "", "B5": "", "B6": "",
  "C1": ""
}
</script>

<script>
/* ========= 所有变量声明统一放顶部，避免“声明前访问” ========= */
let fontPath = null;                // 需要字体时填路径（如 'assets/fonts.ttf'）
let WOMAN_FONT_PATH = null;

const GLITCH_MAP = {
  A1:'assets/glitch_A1.gif', A2:'assets/glitch_A2.gif', A3:'assets/glitch_A3.gif',
  A4:'assets/glitch_A4.gif', A5:'assets/glitch_A5.gif', A6:'assets/glitch_A6.gif',
  B1:'assets/glitch_B1.gif', B2:'assets/glitch_B2.gif', B3:'assets/glitch_B3.gif',
  B4:'assets/glitch_B4.gif', B5:'assets/glitch_B5.gif', B6:'assets/glitch_B6.gif',
  C1:'assets/glitch_C1.gif'
};

let USE_GLITCH_IMAGE = true;
let GLITCH_IMAGE_PATH = GLITCH_MAP[storyKey] || 'assets/glitch_A1.gif';
let EYE_IMAGE_PATH = 'assets/eyes.png';
let EYE_COUNT = 7;

let RESOLUTION=10, ASCII_UPDATE_INTERVAL=3, MOSAIC_LEVELS=6, MOSAIC_ALPHA=255,
    MOSAIC_MIN_GRAY=20, MOSAIC_MAX_GRAY=170, BG_DARKEN_ALPHA=45;

let GLITCH_IMAGE_ALPHA=245, GLITCH_FLASH_PROB=0.015, GLITCH_MIN_FRAMES=15, GLITCH_MAX_FRAMES=30;
let KEY_OUT_BLACK=true, KEY_BLACK_THRESHOLD=28, KEY_BLACK_SOFTNESS=24;

let RIGHT_RATIO=0.56, SAFE_TOP=30, SAFE_RIGHT=30, SAFE_BOTTOM=30, GUTTER=24;
let WOMAN_TEXT = (storyLabel || 'woman'), WOMAN_SIZE=96, WOMAN_LINE_H=1.05, WOMAN_PAD_X=14, WOMAN_PAD_Y=8, WOMAN_COLOR=[255,255,255];
let PARA_SIZE=16, PARA_LINE_H=1.25, PARA_PAD_X=12, PARA_PAD_Y=8, PARA_GAP=12, BOX_FILL=[210,20,20], BOX_ALPHA=220, TEXT_COLOR=[255,255,255], SHADOW_ALPHA=40, SHADOW_OFFSET=2;
let TEAR_INTENSITY=2.0, TEAR_SCALE=0.03, TEAR_ALPHA=35, WRAP_WIDTH_RATIO=0.95;

let RIBBON_BLEED_ENABLED=true, RIBBON_BLEED_DELAY_FRAMES=200, RIBBON_SPAWN_DENSITY=0.00010, RIBBON_DRIP_MAX=350,
    RIBBON_DRIP_SPEED_MIN=0.05, RIBBON_DRIP_SPEED_MAX=0.2, RIBBON_DRIP_LEN_MIN=80, RIBBON_DRIP_LEN_MAX=380,
    RIBBON_DRIP_THICK_MIN=7, RIBBON_DRIP_THICK_MAX=8, RIBBON_DRIP_WOBBLE=0.85, RIBBON_DRIP_ALPHA=230;

let paragraphs = [];
let customFont=null, womanFont=null, video=null, mosaicBuffer=null, mosaicTick=0,
    glitchStill=null, glitchKeyed=null, glitchOn=false, glitchFramesLeft=0;
let rightRect={x:0,y:0,w:0,h:0}, ribbonEdges=[], ribbonDrips=[], ribbonBleedStart=0, ribbonBleedStarted=false;
let eyeImg=null, eyes=[];

/* ========= 生成故事文本 ========= */
function buildStoryParagraphs(){
  const T = JSON.parse(document.getElementById('story-templates').textContent || '{}');
  let key=storyKey; if(!key || !T[key]) return ['（没有找到对应故事模板，请补充 15 篇文本或返回重试）'];
  let txt=T[key] || '';
  if(key.startsWith('A')){
    txt = txt.replaceAll(`[${key}a特征]`, ans[key+'a']||'')
             .replaceAll(`[${key}b特征]`, ans[key+'b']||'')
             .replaceAll(`[${key}c特征]`, ans[key+'c']||'');
  } else if(key.startsWith('B')){
    txt = txt.replaceAll(`[${key}a]`, ans[key+'a']||'')
             .replaceAll(`[${key}b]`, ans[key+'b']||'')
             .replaceAll(`[${key}c]`, ans[key+'c']||'');
  } else if(key==='C1'){
    txt = (T[key]||'').replaceAll('[C1选项]', ans['C1']||'');
  }
  return txt.split('\n').map(s=>s.trim()).filter(Boolean);
}

/* ========= p5：预载/初始化/绘制 ========= */
function preload(){
  paragraphs = buildStoryParagraphs();
  try{ if(fontPath) customFont=loadFont(fontPath); }catch(e){}
  try{ if(WOMAN_FONT_PATH) womanFont=loadFont(WOMAN_FONT_PATH); }catch(e){}
  if(USE_GLITCH_IMAGE){ try{ glitchStill = loadImage(GLITCH_IMAGE_PATH); }catch(e){} }
  eyeImg = loadImage(EYE_IMAGE_PATH, ()=>{}, ()=>{ eyeImg=null; });
}

function setup(){
  createCanvas(windowWidth, windowHeight);
  if(customFont) textFont(customFont);
  textAlign(LEFT,TOP);

  video = createCapture(VIDEO);
  video.size(floor(width/RESOLUTION), floor(height/RESOLUTION));
  video.hide();

  mosaicBuffer = createGraphics(width,height);
  mosaicBuffer.noStroke();

  if(USE_GLITCH_IMAGE && KEY_OUT_BLACK && glitchStill){
    glitchKeyed = keyOutBlack(glitchStill, KEY_BLACK_THRESHOLD, KEY_BLACK_SOFTNESS);
  }

  updateLayout();
  ribbonBleedStart=frameCount;
  initEyes();
}

function draw(){
  background(0);
  drawMosaicBackground();
  if(BG_DARKEN_ALPHA>0){ noStroke(); fill(0,BG_DARKEN_ALPHA); rect(0,0,width,height); }
  if(!glitchOn) drawEyes();
  maybeFlashGlitchImage();
  ribbonEdges.length=0; drawRightColumn(true);
  if(RIBBON_BLEED_ENABLED) bleedRibbons();
  drawRightColumn(false);
}

/* ========= 背景马赛克 ========= */
function drawMosaicBackground(){
  if(!mosaicBuffer || !video) return;
  if(mosaicTick % ASCII_UPDATE_INTERVAL === 0){
    mosaicBuffer.clear(); video.loadPixels();
    for(let y=0;y<video.height;y++){
