<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>如何被写进恐怖故事里 · 结果页</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.dom.min.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#ffecec; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    canvas { display:block; }
    #hint { position:fixed; left:6px; top:6px; color:#ccc; font-size:12px; z-index:5; }
  </style>
</head>
<body>
<div id="hint">Loading...</div>
<script>
/* ====================== 读取问卷 → 选故事键 ====================== */
const payload = (()=>{ try { return JSON.parse(localStorage.getItem('quizPayload')||'{}'); } catch(e){ return {}; } })();
const nameValue = payload.name || '参与者';
const ans = payload.answers || {};
let aHit=null; for(let i=1;i<=6;i++){ if(ans['AA'+i]==='是'){ aHit='A'+i; break; } }
let bHit=null; for(let i=1;i<=6;i++){ if(ans['B'+i]==='是'){ bHit='B'+i; break; } }
const cHit = ans['C1'] ? 'C1' : null;

let storyKey=null, storyTypeLabel='';
if(bHit && cHit){ storyKey=bHit; storyTypeLabel='焦虑原型 '+bHit; }
else if(aHit){  storyKey=aHit; storyTypeLabel='身份原型 '+aHit; }
else if(bHit){  storyKey=bHit; storyTypeLabel='焦虑原型 '+bHit; }
else if(cHit){  storyKey=cHit; storyTypeLabel='伪归类 '+cHit; }
if(!storyKey) storyKey='A1'; // 兜底

/* ====== 标题：写死/自动 二选一 ====== */
// 想固定标题，改成字符串；想用自动标签，设为 null
const CUSTOM_TITLE_TEXT = null;

/* ====================== 故事模板（示例） ====================== */
const T = {
  A1: `她第一次来我们办公室的时候，大家都说她很有礼貌，说话轻声细语，穿着合身，笑起来像谁都不会拒绝的人。
领导很喜欢她，说她“像我们这行该有的样子”。她从不迟到，桌子永远整整齐齐，午饭吃得不多，话也不多。
有时候我偷偷看她自拍：角度永远一样，下巴朝镜头对齐，[A1a特征]，[A1c特征]。
她和谁都处得很好，只是没人见过她真正生气，或者真正开心。她每一次笑都像是按下某种按钮才启动的。[A1b特征]。
有天晚上我们加班，办公室只剩我和她。我走过去想问她要不要一起走，结果看到她正在镜子前低头调整什么。不是妆容，不是衣领——是脸。
她把脸从脸上慢慢剥下来，从额头撕开，再一寸一寸地卷到下巴。里面是空的。只有白白的塑料架子，像模特头。
她回头的时候，那张脸正挂在手里，可她还在笑。和照片里一模一样的笑。`,
  A2:``,A3:``,A4:``,A5:``,A6:``,
  B1:``,B2:``,B3:``,B4:``,B5:``,B6:``,
  C1:``
};

function buildStoryParagraphs(){
  let key=storyKey; if(!key || !T[key]) return ['（没有找到对应故事模板，请补齐 15 篇文本）'];
  let txt=T[key];
  if(key.startsWith('A')){
    txt = txt.replaceAll(`[${key}a特征]`, ans[key+'a']||'')
             .replaceAll(`[${key}b特征]`, ans[key+'b']||'')
             .replaceAll(`[${key}c特征]`, ans[key+'c']||'');
  } else if(key.startsWith('B')){
    txt = txt.replaceAll(`[${key}a]`, ans[key+'a']||'')
             .replaceAll(`[${key}b]`, ans[key+'b']||'')
             .replaceAll(`[${key}c]`, ans[key+'c']||'');
  } else if(key==='C1'){
    txt = (T[key]||'').replaceAll('[C1选项]', ans['C1']||'');
  }
  return txt.split('\n').map(s=>s.trim()).filter(Boolean);
}

/* ====================== 资源与参数 ====================== */
const GLITCH_MAP = {
  A1:'assets/glitch_A1.gif', A2:'assets/glitch_A2.gif', A3:'assets/glitch_A3.gif', A4:'assets/glitch_A4.gif', A5:'assets/glitch_A5.gif', A6:'assets/glitch_A6.gif',
  B1:'assets/glitch_B1.gif', B2:'assets/glitch_B2.gif', B3:'assets/glitch_B3.gif', B4:'assets/glitch_B4.gif', B5:'assets/glitch_B5.gif', B6:'assets/glitch_B6.gif',
  C1:'assets/glitch_C1.gif'
};
let GLITCH_IMAGE_PATH = GLITCH_MAP[storyKey] || 'assets/glitch_A1.gif';
const EYE_IMAGE_PATH = 'assets/eyes.png';

let RIGHT_RATIO = 0.58;
const SAFE_TOP=24, SAFE_RIGHT=24, SAFE_BOTTOM=24, GUTTER=18;
let WOMAN_TEXT = CUSTOM_TITLE_TEXT || storyTypeLabel;
let WOMAN_SIZE=92, WOMAN_LINE_H=1.05, WOMAN_PAD_X=14, WOMAN_PAD_Y=8;
let PARA_SIZE=16, PARA_LINE_H=1.28, PARA_PAD_X=12, PARA_PAD_Y=9, PARA_GAP=12;
let WRAP_WIDTH_RATIO = 0.96;

const BOX_FILL=[210,20,20], BOX_ALPHA=220, TEXT_COLOR=[255,255,255];
const SHADOW_ALPHA=36, SHADOW_OFFSET=2;
const TEAR_INTENSITY=2.0, TEAR_SCALE=0.03, TEAR_ALPHA=32;

const RESOLUTION=10, ASCII_UPDATE_INTERVAL=3, MOSAIC_LEVELS=6, MOSAIC_ALPHA=255, MOSAIC_MIN_GRAY=22, MOSAIC_MAX_GRAY=168, BG_DARKEN_ALPHA=52;

const GLITCH_IMAGE_ALPHA=240, GLITCH_FLASH_PROB=0.012, GLITCH_MIN_FRAMES=14, GLITCH_MAX_FRAMES=28;
const KEY_OUT_BLACK=true, KEY_BLACK_THRESHOLD=28, KEY_BLACK_SOFTNESS=24;

/* ====================== 运行状态 ====================== */
let video=null, camReady=false;
let mosaicBuffer=null, mosaicTick=0;
let glitchStill=null, glitchKeyed=null, glitchOn=false, glitchFramesLeft=0;
let rightRect={x:0,y:0,w:0,h:0};
let paragraphs = buildStoryParagraphs();
let eyeImg=null, eyes=[], EYE_COUNT=7;

/* ====================== 预加载（不再加载外部字体，避免报错） ====================== */
function preload(){
  glitchStill = loadImage(GLITCH_IMAGE_PATH, ()=>{}, ()=>{ glitchStill=null; });
  eyeImg = loadImage(EYE_IMAGE_PATH, ()=>{}, ()=>{ eyeImg=null; });
}

/* ====================== 初始化 ====================== */
function setup(){
  createCanvas(windowWidth, windowHeight);
  textAlign(LEFT,TOP);

  // 摄像头：拿不到时 camReady=false，走降级背景
  try{
    video = createCapture({video:true, audio:false}, ()=>{ camReady=true; });
    if(video){ video.size(floor(width/RESOLUTION), floor(height/RESOLUTION)); video.hide(); }
  }catch(e){ camReady=false; }

  mosaicBuffer = createGraphics(width, height); mosaicBuffer.noStroke();

  if (glitchStill && KEY_OUT_BLACK){
    glitchKeyed = keyOutBlack(glitchStill, KEY_BLACK_THRESHOLD, KEY_BLACK_SOFTNESS);
  }

  updateLayout();
  initEyes();

  const hint = document.getElementById('hint'); if(hint) hint.style.display='none';
}

/* ====================== 每帧 ====================== */
function draw(){
  background(0);
  drawMosaicBackground();
  if(BG_DARKEN_ALPHA>0){ noStroke(); fill(0,BG_DARKEN_ALPHA); rect(0,0,width,height); }

  if(!glitchOn) drawEyes();
  maybeFlashGlitchImage();
  drawRightColumn();
}

/* ====================== 布局与自适应 ====================== */
function updateLayout(){
  const rightX = floor(width*RIGHT_RATIO)+GUTTER;
  const rightW = max(240, width-rightX-SAFE_RIGHT);
  const rightY = SAFE_TOP;
  const rightH = height - SAFE_TOP - SAFE_BOTTOM;
  rightRect = {x:rightX, y:rightY, w:rightW, h:rightH};

  const baseH = height;
  WOMAN_SIZE = constrain(round(map(baseH, 520, 1080, 64, 100)), 60, 104);
  PARA_SIZE  = constrain(round(map(baseH, 520, 1080, 14, 20)), 14, 20);
  autosizeParagraphs();
}
function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
  mosaicBuffer=createGraphics(width, height); mosaicBuffer.noStroke();
  if(video){ try{ video.size(floor(width/RESOLUTION), floor(height/RESOLUTION)); }catch(e){} }
  updateLayout(); initEyes();
}
function autosizeParagraphs(){
  textSize(WOMAN_SIZE); textLeading(WOMAN_SIZE*WOMAN_LINE_H);
  const titleLines = wrapLines(WOMAN_TEXT, rightRect.w*WRAP_WIDTH_RATIO, WOMAN_SIZE);
  const titleH = (WOMAN_PAD_Y*2) + titleLines.length*(WOMAN_SIZE + WOMAN_PAD_Y*2);

  textSize(PARA_SIZE); textLeading(PARA_SIZE*PARA_LINE_H);
  const wrapW = rightRect.w*WRAP_WIDTH_RATIO;
  let paraTotalH = 0;
  for(const p of paragraphs){
    const lines = wrapLines(p, wrapW, PARA_SIZE);
    const boxH = PARA_PAD_Y*2 + lines.length*(PARA_SIZE + PARA_PAD_Y*2);
    paraTotalH += boxH + PARA_GAP;
  }
  const total = titleH + paraTotalH;
  if (total > rightRect.h){
    const ratio = rightRect.h / total;
    const newPara = max(12, floor(PARA_SIZE*ratio*0.98));
    if (newPara < PARA_SIZE){ PARA_SIZE = newPara; }
  }
}

/* ====================== 红丝带 ====================== */
function drawRightColumn(){
  let cursorY = rightRect.y;

  // 标题
  textSize(WOMAN_SIZE); textLeading(WOMAN_SIZE*WOMAN_LINE_H);
  const titleLines = wrapLines(WOMAN_TEXT, rightRect.w*WRAP_WIDTH_RATIO, WOMAN_SIZE);
  cursorY = drawRibbonBlock(titleLines, rightRect.x, cursorY, WOMAN_SIZE, WOMAN_PAD_X, WOMAN_PAD_Y, BOX_FILL, BOX_ALPHA, [255,255,255]);
  cursorY += PARA_GAP*1.2;

  // 段落
  textSize(PARA_SIZE); textLeading(PARA_SIZE*PARA_LINE_H);
  const wrapW = rightRect.w*WRAP_WIDTH_RATIO;
  for (const p of paragraphs){
    const lines = wrapLines(p, wrapW, PARA_SIZE);
    cursorY = drawRibbonBlock(lines, rightRect.x, cursorY, PARA_SIZE, PARA_PAD_X, PARA_PAD_Y, BOX_FILL, BOX_ALPHA, TEXT_COLOR);
    cursorY += PARA_GAP;
    if (cursorY > rightRect.y + rightRect.h - 8) break;
  }
}
function drawRibbonBlock(lines, x, y, fontSize, padX, padY, fillRGB, fillAlpha, textRGB){
  const widths = lines.map(s=>max(1, textWidth(s.replace(/\s+$/,''))));
  const boxWs = widths.map(w=>w + padX*2);
  const boxH  = fontSize + padY*2;

  drawRibbonShape(x+SHADOW_OFFSET, y+SHADOW_OFFSET, boxWs, boxH, color(0,SHADOW_ALPHA), null);
  drawRibbonShape(x, y, boxWs, boxH, color(fillRGB[0],fillRGB[1],fillRGB[2],fillAlpha), {tear:true});

  fill(textRGB[0], textRGB[1], textRGB[2]); noStroke();
  for (let i=0;i<lines.length;i++){
    const s = lines[i].replace(/\s+$/,''); const ty = y + padY + i*boxH;
    text(s, x+padX, ty);
  }
  return y + lines.length*boxH;
}
function drawRibbonShape(x,y,boxWs,boxH,fillCol,opt={tear:false}){
  const pts = buildRibbonOutline(x,y,boxWs,boxH);
  noStroke(); fill(fillCol); beginShape(); for(const p of pts) vertex(p.x,p.y); endShape(CLOSE);
  if(opt && opt.tear){
    noFill(); stroke(255, TEAR_ALPHA); strokeWeight(2);
    beginShape();
    for(const p of pts){
      const jx=(noise(p.x*TEAR_SCALE,p.y*TEAR_SCALE)-.5)*2*TEAR_INTENSITY;
      const jy=(noise(p.x*TEAR_SCALE+999,p.y*TEAR_SCALE+999)-.5)*2*TEAR_INTENSITY;
      vertex(p.x+jx, p.y+jy);
    }
    endShape(CLOSE);
  }
}
function buildRibbonOutline(x,y,boxWs,boxH){
  const n=boxWs.length, pts=[];
  pts.push({x:x,y:y});
  pts.push({x:x+boxWs[0], y:y});
  for(let i=0;i<n;i++){
    pts.push({x:x+boxWs[i], y:y+(i+1)*boxH});
    if(i<n-1) pts.push({x:x+boxWs[i+1], y:y+(i+1)*boxH});
  }
  pts.push({x:x, y:y+n*boxH});
  pts.push({x:x, y:y});
  return pts;
}

/* ====================== 换行 ====================== */
function wrapLines(textStr, maxW, fontSize){
  const tokens = textStr.split(/(\s+)/);
  let lines=['']; textSize(fontSize);
  for(const tk of tokens){
    const trial=lines[lines.length-1]+tk;
    if(textWidth(trial)<=maxW || lines[lines.length-1]===''){ lines[lines.length-1]=trial; }
    else { lines.push(tk.trimStart()); }
  }
  return lines.map(s=>s.replace(/\s+$/,''));
}

/* ====================== 背景（稳态：无摄像头时降级） ====================== */
function drawMosaicBackground(){
  if(mosaicTick % ASCII_UPDATE_INTERVAL === 0){
    mosaicBuffer.clear();
    if(camReady && video && video.loadedmetadata){
      try{ video.loadPixels(); }catch(e){}
      for(let y=0;y<video.height;y++){
        for(let x=0;x<video.width;x++){
          const idx=(x+y*video.width)*4;
          const r=video.pixels[idx], g=video.pixels[idx+1], b=video.pixels[idx+2];
          const bright=(r+g+b)/3;
          const level=floor(map(bright,0,255,0,MOSAIC_LEVELS));
          const q=map(level,0,MOSAIC_LEVELS-1,MOSAIC_MIN_GRAY,MOSAIC_MAX_GRAY);
          mosaicBuffer.fill(q, MOSAIC_ALPHA);
          mosaicBuffer.rect(x*RESOLUTION,y*RESOLUTION,RESOLUTION,RESOLUTION);
        }
      }
    }else{
      // 降级：随机噪声的灰块背景（无摄像头也能正常显示）
      const cols = ceil(width/RESOLUTION), rows = ceil(height/RESOLUTION);
      for(let j=0;j<rows;j++){
        for(let i=0;i<cols;i++){
          const n = noise(i*0.12, j*0.12, frameCount*0.01);
          const level = floor(map(n,0,1,0,MOSAIC_LEVELS));
          const q = map(level,0,MOSAIC_LEVELS-1,MOSAIC_MIN_GRAY,MOSAIC_MAX_GRAY);
          mosaicBuffer.fill(q, MOSAIC_ALPHA);
          mosaicBuffer.rect(i*RESOLUTION, j*RESOLUTION, RESOLUTION, RESOLUTION);
        }
      }
    }
  }
  mosaicTick++; image(mosaicBuffer,0,0);
}

/* ====================== glitch ====================== */
function maybeFlashGlitchImage(){
  if(!glitchStill) return;
  if(!glitchOn && random()<GLITCH_FLASH_PROB){
    glitchOn=true; glitchFramesLeft=floor(random(GLITCH_MIN_FRAMES, GLITCH_MAX_FRAMES+1));
  }
  if(glitchOn){
    push(); tint(255,GLITCH_IMAGE_ALPHA);
    const img = glitchKeyed || glitchStill;
    const cs=min(width,height), is=min(img.width,img.height);
    const sc=cs/is, dw=img.width*sc, dh=img.height*sc, dx=(width-dw)/2, dy=(height-dh)/2;
    image(img,dx,dy,dw,dh); pop();
    if(--glitchFramesLeft<=0) glitchOn=false;
  }
}

/* ====================== 小眼睛 ====================== */
function initEyes(){
  eyes=[]; if(!eyeImg) return;
  for(let i=0;i<EYE_COUNT;i++){
    const margin=40;
    const x=random(margin,width-margin);
    const y=random(margin,height-margin);
    const targetW = random(90,140)*(width/1280*0.9+0.55);
    const targetH = targetW*(eyeImg.height/eyeImg.width);
    eyes.push({ baseX:x, baseY:y, w:targetW, h:targetH, amp:random(4,10), spd:random(0.015,0.035), phase:random(TWO_PI), rotAmp:random(-0.06,0.06) });
  }
}
function drawEyes(){
  if(!eyeImg || eyes.length===0) return;
  push(); imageMode(CENTER);
  for(const e of eyes){
    const dy=sin(frameCount*e.spd+e.phase)*e.amp;
    const dx=cos(frameCount*e.spd*0.8+e.phase)*e.amp*0.35;
    const rot=sin(frameCount*e.spd*0.6+e.phase)*e.rotAmp;
    push(); translate(e.baseX+dx, e.baseY+dy); rotate(rot); image(eyeImg,0,0,e.w,e.h); pop();
  }
  pop();
}

/* ====================== 抠黑工具 ====================== */
function keyOutBlack(srcImg, threshold=28, softness=24){
  let keyed=createImage(srcImg.width, srcImg.height);
  keyed.copy(srcImg,0,0,srcImg.width,srcImg.height,0,0,srcImg.width,srcImg.height);
  keyed.loadPixels();
  const n=keyed.width*keyed.height;
  for(let i=0;i<n;i++){
    const idx=i*4, r=keyed.pixels[idx], g=keyed.pixels[idx+1], b=keyed.pixels[idx+2], a0=keyed.pixels[idx+3];
    const bright=(r+g+b)/3;
    if(bright<=threshold) keyed.pixels[idx+3]=0;
    else if(softness>0 && bright<threshold+softness){
      const t=(bright-threshold)/softness; keyed.pixels[idx+3]=a0*t;
    }
  }
  keyed.updatePixels(); return keyed;
}
</script>
</body>
</html>
