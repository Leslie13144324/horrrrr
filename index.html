<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>如何被写进恐怖故事里 · 答题页</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.dom.min.js"></script>
  <style>
    :root { --red:#ff3b3b; }
    html,body{margin:0;padding:0;height:100%;background:#000;color:#ffecec;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #sketch-holder{position:fixed;inset:0;z-index:0}
    .vignette{position:fixed;inset:0;pointer-events:none;z-index:2;
      background:radial-gradient(ellipse at center,rgba(0,0,0,0) 35%,rgba(0,0,0,.55) 100%)}
    #ui{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:3;pointer-events:none}

    /* —— 无卡片，仅保留居中 —— */
    .card{
      pointer-events:auto;width:min(780px,92vw);
      background:transparent;border:none;padding:20px 0 16px;box-shadow:none;backdrop-filter:none;
    }

    .title{
      font-size:clamp(22px,3.2vw,34px);
      line-height:1.6;color:#fff2f2;margin-bottom:16px;
      text-shadow:0 0 18px rgba(255,255,255,.07);
    }

    .row{display:grid;gap:10px}
    .row.cols-2{grid-template-columns:1fr 1fr}

    /* —— 纯文字按钮：无边框、无底色 —— */
    .btn{
      appearance:none;-webkit-appearance:none;background:transparent;border:none;border-radius:0;
      color:#ffd6d6;padding:6px 2px;text-align:left;cursor:pointer;
      font:inherit;font-size:clamp(18px,2.2vw,24px);line-height:1.5;
      outline:none;transition:opacity .15s ease, transform .06s ease;
      opacity:.92;display:block;text-shadow:0 0 10px rgba(0,0,0,.35);
    }
    .btn:hover{opacity:1;transform:translateY(-1px)}
    .btn:focus-visible{text-decoration:underline;text-underline-offset:3px}

    .input{
      width:100%;background:transparent;color:#fff;border:none;
      border-bottom:1px dashed rgba(255,80,80,.45);padding:8px 4px;outline:none;font-size:18px
    }

    .progress{height:6px;width:100%;background:#171717;border-radius:999px;overflow:hidden;margin:0 0 8px}
    .bar{height:100%;background:var(--red);width:0%;transition:width .25s ease}
  </style>
</head>
<body>
  <div id="sketch-holder"></div>
  <div class="vignette"></div>
  <main id="ui">
    <div class="card">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="title" id="title">请在下方输入你的名字：</div>
      <div class="row" id="content"></div>
      <!-- ✂️ 无题数文本 -->
    </div>
  </main>

<script>
/* ===== 跳转配置 ===== */
const RESULT_URL = "./story.html";
const USE_LOCAL_STORAGE = true;

/* ===== 故障强度随题数提升（原样） ===== */
function paramsByProgress(n){
  const t = constrain(n/13, 0, 1), e = t*t*(3-2*t);
  return { amp:lerp(0,60,e), slices:int(lerp(0,48,e)), blocks:int(lerp(0,28,e)),
           scanGap:max(2,int(lerp(8,3,e))), scanAlpha:int(lerp(0,120,e)),
           chroma:int(lerp(0,140,e)), haze:lerp(14,0,e) };
}

/* ===== 题库（与你给的一致） ===== */
const YES='是', NO='否';

const A_QUESTIONS = [
  { id:'A1', main:'A1. 从小到大，你总被提醒，女孩子要有女孩子的样子', anchorId:'AA1', anchor:'AA1. 你时常感觉做女人无论怎么表现，总有人觉得你不够好',
    supplements:[
      { id:'A1a', text:'A1a. 你照片里的头发，总是', options:[
        { label:'直发',   fill:'她的头发像被刀切过一样整齐，一根不偏，像是贴图而不是长出来的。' },
        { label:'有刘海', fill:'她的刘海像量角器画出来的，一丝不差，像测量用的。' },
        { label:'卷发',   fill:'她看上去像卷发的洋娃娃贴纸一样存在于照片里，背景动，她不动。' },
      ]},
      { id:'A1b', text:'A1b. 你穿的衣服，通常是', options:[
        { label:'你常穿那些不记得什么时候买的衣服，但总能刚刚好搭上。', fill:'她的笑容从来不变，像被印在脸上的，精确得像表盘一样没有误差。' },
        { label:'你每天穿着差不多的搭配，头发也总是差不多的样子。',       fill:'她的头发像早上被放回去的位置，每一根都站队集合。' },
        { label:'你喜欢统一风格，看起来像有一套“自己定制的衣服”。', fill:'她的衣服像是批量复制的模板，没有褶皱也没有体温。' },
      ]},
      { id:'A1c', text:'A1c. 你在人多的地方时，身体有没有自己动过？', options:[
        { label:'肩膀会先收一下，再把背挺直，像有人在看你。', fill:'她站得太直了，好像有人在身后绑着她的脊柱。' },
        { label:'嘴角会先抿一抿，然后迅速拉成标准的笑。', fill:'她笑得很快，但像贴了两张一模一样的嘴皮。' },
        { label:'站着的时候脚会平行，膝盖朝前，像排队一样等着发生什么。', fill:'她的腿像摆在展柜里的模特，没有重量，没有动作的权利。' },
      ]},
    ] },

  { id:'A2', main:'A2. 你喜欢的人和父母本来期待的不一样', anchorId:'AA2', anchor:'AA2. 因为“你喜欢谁”这件事，你被明里或暗里说过“该纠正”',
    supplements:[
      { id:'A2a', text:'A2a. 当你路过镜面或玻璃时，你的影子会', options:[
        { label:'比你先行动，总比你早半步转头。', fill:'她的影子像提前收到指令，永远抢先一步。' },
        { label:'出现两层，彼此轻微错位。', fill:'她有两层影子，像没对齐的印刷。' },
        { label:'与别人的影子短暂叠合，再分开。', fill:'她的影子像会“试探地贴近别人”，随后迅速退回。' },
      ]},
      { id:'A2b', text:'A2b. 当你听到别人说“正常”的时候，你的身体会', options:[
        { label:'耳边出现收音机失真的嗡鸣。', fill:'耳后像藏着小小的电台，在噪声里呼吸。' },
        { label:'胸口发冷，像被风从里向外吹。', fill:'胸口僵直，像无法呼吸。' },
        { label:'下意识把手背到身后，像要藏起什么。', fill:'手在身后摸索，像在按一个看不见的开关。' },
      ]},
      { id:'A2c', text:'A2c. 当他们逼你回答“你到底是什么”的时候，你会', options:[
        { label:'只点头或摇头，不说词语。', fill:'她的嗓子像被薄膜封住，只剩动作在回答。' },
        { label:'笑一下，再反问一个无关紧要的问题。', fill:'她突然大笑，笑声像偏离轨道的指针，指向时间以外的地方。' },
        { label:'把问题重复一遍，像在回声里拖延时间。', fill:'她的回答声却没人听见，声音像回到了她身上，像在她体内绕圈。' },
      ]},
    ] },

  { id:'A3', main:'A3. 你的身体或精神状况，时常让你觉得和健康的人不一样', anchorId:'AA3', anchor:'AA3. 日常的一些小事，对你来说会比别人更麻烦',
    supplements:[
      { id:'A3a', text:'A3a. 早上醒来，你会', options:[
        { label:'先摸一摸枕边的东西。', fill:'时常手在前方不断摸索。' },
        { label:'盯着天花板发一会儿呆。', fill:'眼睛直直对着天花板，像在数裂缝。' },
        { label:'坐起来很快，好像突然被惊动。', fill:'时常像是突然被惊醒了一样，猛地坐起。' },
      ]},
      { id:'A3b', text:'A3b. 你在别人眼中最容易被评价为', options:[
        { label:'“看起来很瘦弱。”', fill:'那人的影子像比本人还窄一圈。' },
        { label:'“有点神经质。”', fill:'那人的动作像被拉得过紧的线。' },
        { label:'“心思太多。”', fill:'那人额头总是阴沉，好像压着什么没说完的话。' },
      ]},
      { id:'A3c', text:'A3c. 当你不舒服时，你常会', options:[
        { label:'一个劲儿走来走去。', fill:'那人在楼道里来回，脚步像在磨地板。' },
        { label:'不停写写画画。', fill:'那人的面前堆着很厚的纸张，满是破碎的符号。' },
        { label:'发呆，直到忘记时间。', fill:'那人坐在那里，像一件没收走的旧物。' },
      ]},
    ] },

  { id:'A4', main:'A4. 你曾经搬离过熟悉的地方，在陌生的城市生活过', anchorId:'AA4', anchor:'AA4. 你住的地方和你成长的家乡差别大',
    supplements:[
      { id:'A4a', text:'A4a. 你的声音总是带着', options:[
        { label:'口音',   fill:'口音里夹杂异乡的腔调。' },
        { label:'奇怪停顿', fill:'那声音是断断续续的。' },
        { label:'过快语速', fill:'语速急促却听不清具体的内容。' },
      ]},
      { id:'A4b', text:'A4b. 你的样子最容易被人记住的地方是', options:[
        { label:'肤色', fill:'那和周围格格不入的皮肤。' },
        { label:'穿着', fill:'那怎么看都不像本地样式的穿着。' },
        { label:'眼神', fill:'那极其飘忽的眼神。' },
      ]},
      { id:'A4c', text:'A4c. 在人群中，你身上散发的气味让人觉得', options:[
        { label:'潮湿', fill:'路途里没干透的雨衣的味道。' },
        { label:'辛辣', fill:'远方辛辣的香料味。' },
        { label:'陌生', fill:'说不出的异味。' },
      ]},
    ] },

  { id:'A5', main:'A5. 你在成长过程中，经常需要压抑自己的真实想法或情绪', anchorId:'AA5', anchor:'AA5. 你是否觉得，在家里你的声音经常被忽视或被打断',
    supplements:[
      { id:'A5a', text:'A5a. 当你试图表达意见时，他们最常对你说', options:[
        { label:'安静',     fill:'安静' },
        { label:'没必要',   fill:'没必要' },
        { label:'别人都这样', fill:'别人都这样' },
      ]},
      { id:'A5b', text:'A5b. 在家中，你最常被要求做到的事情是', options:[
        { label:'听话', fill:'听话' },
        { label:'懂事', fill:'你要懂事' },
        { label:'忍耐', fill:'要学会忍耐' },
      ]},
      { id:'A5c', text:'A5c. 你房间最深的角落里藏着', options:[
        { label:'一堆作业本', fill:'一本作业本' },
        { label:'一只破旧玩偶', fill:'一只破旧玩偶' },
        { label:'一把锁', fill:'一把陈旧的锁' },
      ]},
    ] },

  { id:'A6', main:'A6. 你不是在人群里容易被注意到的那类人', anchorId:'AA6', anchor:'AA6. 在社交场合，你总觉得被忽略或无所适从',
    supplements:[
      { id:'A6a', text:'A6a. 如果有人仔细看你的脸，会觉得……', options:[
        { label:'你眨眼很慢',   fill:'眼皮下垂得像要闭上。' },
        { label:'你很爱笑',     fill:'脸上带着僵直的笑。' },
        { label:'你的呼吸很轻', fill:'哪怕走得很近也根本听不到呼吸声。' },
      ]},
      { id:'A6b', text:'A6b. 你学生时期最喜欢坐的位置是', options:[
        { label:'靠窗',   fill:'靠窗' },
        { label:'讲台边', fill:'讲台边' },
        { label:'最后一排', fill:'最后一排' },
      ]},
      { id:'A6c', text:'A6c. 你觉得下面哪项活动最有意思', options:[
        { label:'搓纸片', fill:'在手中把纸一点点搓成小团。' },
        { label:'描字',   fill:'一笔一划在本子上写着什么，把字描得很重。' },
        { label:'观察别人', fill:'直直地盯着人看。' },
      ]},
    ] },
];

const C1 = { id:'C1', text:'C1. 他们说，你之所以异样，是因为——（必须选择一条）',
  options:['你看起来不像这里的人','你总是躲在镜头外','你说话的方式让人不安'] };

const B_QUESTIONS = [
  { id:'B1', main:'B1. 在亲密关系里，你是否始终觉得缺了一点安全感？',
    supplements:[
      { id:'B1a', text:'B1a. 你最常记得你的伴侣身上的气味是', options:[
        { label:'清晨的露水味', fill:'伴侣身上一直都是清晨的露水味，但最近有一次凑近时，我发现那股清凉里混进酸烂的气息，像尸体泡在湿土里。' },
        { label:'衣服刚烘干的阳光味', fill:'伴侣身上一直都是衣服刚烘干的阳光味，但最近有一次凑近时，我闻到一股焦糊刺鼻的气息，像烧焦的皮肉。' },
        { label:'书页的气息', fill:'伴侣身上一直都是淡淡的书页气息，但最近有一次凑近时，我嗅到一股潮湿腐霉味，像墨迹溃烂。' },
      ]},
      { id:'B1b', text:'B1b. 你的伴侣最常做的小动作是', options:[
        { label:'抠指甲', fill:'伴侣坐在床边，手指在黑暗里不停摩擦，反复抠着指甲，指甲屑一点点落下，缝隙里渗出红色的血。' },
        { label:'咳嗽',   fill:'伴侣坐在床边，身体微微前倾，轻轻咳嗽，喉咙里的声音像有什么湿滑的东西在爬动。' },
        { label:'盯着我看', fill:'伴侣坐在床边，眼睛一眨不眨地盯着我，呼吸浅得几乎听不见，像在等我眨眼时爬进来。' },
      ]},
      { id:'B1c', text:'B1c. 你的伴侣房间里最显眼的一样东西是', options:[
        { label:'一面镜子',   fill:'床边摆的镜子里似乎有什么东西一闪而过。' },
        { label:'一只旧水杯', fill:'床头放的水杯里水面轻轻荡漾着，浑浊的颜色像氧化过的血。' },
        { label:'一盏小台灯', fill:'床角的一盏小台灯亮着，灯光闪烁不定。' },
      ]},
    ] },

  { id:'B2', main:'B2. 在生活里，你是否有时会觉得有些陌生的存在，正在悄悄靠近你？',
    supplements:[
      { id:'B2a', text:'B2a. 你更容易注意到哪种声音？', options:[
        { label:'拖鞋拖在地上的声音', fill:'那声音很轻，像拖鞋在粗糙地面来回摩擦。' },
        { label:'压抑着的咳嗽',     fill:'那声音断断续续，像咳嗽被硬生生憋住。' },
        { label:'低声念字',         fill:'那声音模糊不清，像有人反复低声念着相同的字。' },
      ]},
      { id:'B2b', text:'B2b. 如果你突然看见一个人，你最先注意到', options:[
        { label:'衣角', fill:'她垂下的衣角，沾着潮湿的泥点。' },
        { label:'手背', fill:'第一眼看见的是苍白的手背，上面布满细密的划痕。' },
        { label:'鞋子', fill:'他的一双鞋，鞋底磨得破烂，边缘卷起。' },
      ]},
      { id:'B2c', text:'B2c. 哪种气味最让你难以忽视？', options:[
        { label:'生铁味', fill:'像带着生铁的腥气，仿佛血在金属里凝固。' },
        { label:'湿泥味', fill:'像刚翻开的土堆里潮湿的泥味。' },
        { label:'焦糊味', fill:'空气里带着焦糊的气息，刺得眼睛直流泪。' },
      ]},
    ] },
];

/* ===== 画布 & 背景（原样） ===== */
let video, pg, camReady=false;
let totalAsked=0, contentDiv,titleDiv,barDiv;

function setup(){
  const holder=document.getElementById('sketch-holder');
  createCanvas(window.innerWidth, window.innerHeight).parent(holder);
  pixelDensity(1); pg=createGraphics(width,height);

  try{
    video=createCapture({video:true,audio:false}, ()=>{camReady=true;});
    video.size(640,480); video.hide();
  }catch(e){ camReady=false; }

  contentDiv = select('#content');
  titleDiv = select('#title');
  barDiv = select('#bar');

  renderIntro();
}

function windowResized(){ resizeCanvas(window.innerWidth, window.innerHeight); pg=createGraphics(width,height); }

function draw(){
  if(camReady && video){
    pg.push(); pg.clear(); pg.translate(pg.width,0); pg.scale(-1,1);
    const w=pg.width,h=pg.height,vw=video.width,vh=video.height; const s=max(w/vw,h/vh); const dw=vw*s, dh=vh*s;
    pg.image(video,(w-dw)/2,(h-dh)/2,dw,dh); pg.pop();

    const p = paramsByProgress(totalAsked);
    if (p.haze > 0) { pg.filter(BLUR, p.haze/12); pg.fill(255, 20); pg.noStroke(); pg.rect(0,0,pg.width,pg.height); }

    applyGlitchProgressive(pg, p); image(pg,0,0,width,height);

    if (p.chroma > 0){
      const off = int(map(noise(millis()*0.004), 0, 1, -p.amp/2.5, p.amp/2.5));
      blendMode(ADD);
      tint(255,60,60, p.chroma); image(pg,  off, 0);
      tint(60,255,60, p.chroma); image(pg, -off, 0);
      tint(60,60,255, p.chroma); image(pg,   0, off/2);
      noTint(); blendMode(BLEND);
    }
  }else{
    const g = drawingContext.createLinearGradient(0,0,width,height); g.addColorStop(0,'#0b0b0b'); g.addColorStop(1,'#1a0c0c');
    drawingContext.fillStyle=g; noStroke(); rect(0,0,width,height);
    noFill(); stroke(255,12); for(let i=0;i<height;i+=22) line(0,i,width,i);
  }
}

function applyGlitchProgressive(g, p){
  const t = millis()*0.001;
  for(let i=0;i<p.slices;i++){
    const sh=int(random(6,24)); const y=int(random(0,g.height-sh));
    const dx=int(map(noise(t*3+i*.17),0,1,-p.amp,p.amp));
    g.copy(g,0,y,g.width,sh, dx,y,g.width,sh);
  }
  for(let i=0;i<p.blocks;i++){
    const bw=int(random(40,160)), bh=int(random(14,60));
    const sx=int(random(0,g.width-bw)), sy=int(random(0,g.height-bh));
    const dx=int(sx + map(noise(t*2.4+i*.31),0,1,-p.amp,p.amp));
    const dy=int(sy + map(noise(t*2.7+i*.37),0,1,-p.amp*.6,p.amp*.6));
    g.copy(g,sx,sy,bw,bh, dx,dy,bw,bh);
  }
  if (p.scanAlpha>0){ g.noStroke(); g.fill(255,p.scanAlpha); const gap=p.scanGap; const off=int((sin(t*5.2)*.5+.5)*gap);
    for(let y=off; y<g.height; y+=gap){ if (y%(gap*2)===0) g.rect(0,y,g.width,2); } }
}

/* ===== 问卷逻辑 ===== */
let stage='intro', nameValue='';
let aIndex=0, pendingAAnchor=false, pendingASuppIndex=-1;
let bIndex=0, pendingBSuppIndex=-1;
let identityCount=0, anxietyCount=0;
const answers={};

let activeButtons=[]; let inputEl, startBtn;

/* 去编号显示：把 A1./A1a./AA2. 等前缀干掉 */
function stripLeadingId(s){ return String(s).replace(/^[A-Z]{1,2}\d+[a-z]?\.?\s*/,''); }

function clearUI(){
  activeButtons.forEach(b=>b.remove());
  activeButtons=[];
  if(inputEl){inputEl.remove();inputEl=null;}
  if(startBtn){startBtn.remove();startBtn=null;}
}
function setBar(){ const pct=Math.min(100, Math.round((totalAsked/13)*100)); barDiv.elt.style.width=pct+'%'; }
function recordAnswer(qid,val){ answers[qid]=val; totalAsked++; setBar(); }

// Intro
function renderIntro(){
  stage='intro'; titleDiv.html('请在下方输入你的名字：'); clearUI();
  contentDiv.elt.className='row cols-2';
  inputEl=createInput(''); inputEl.addClass('input'); inputEl.parent(contentDiv);
  startBtn=createButton('开始答题'); startBtn.addClass('btn'); startBtn.parent(contentDiv); activeButtons.push(startBtn);
  startBtn.mousePressed(()=>{
    const v=inputEl.value().trim(); if(!v) return;
    nameValue=v; contentDiv.elt.className='row'; goA();
  });
  setBar();
}

// A：命中一个身份原型 →（问完补充）→ 直接 D；A 全否 → C1 → B
function goA(){ stage='A'; clearUI(); pendingAAnchor=false; pendingASuppIndex=-1; renderA(); }
function renderA(){
  const q=A_QUESTIONS[aIndex];
  if(!q){ return goC1(); }

  // —— 主问 / 锚点问 / 补充问 分支
  if(!pendingAAnchor && pendingASuppIndex===-1){
    titleDiv.html(stripLeadingId(q.main));
    renderOptions([{label:YES,on:()=>onAMain(q,YES)},{label:NO,on:()=>onAMain(q,NO)}],2);
    return;
  }
  if(pendingAAnchor && pendingASuppIndex===-1){
    titleDiv.html(stripLeadingId(q.anchor));
    renderOptions([{label:YES,on:()=>onAAnchor(q,YES)},{label:NO,on:()=>onAAnchor(q,NO)}],2);
    return;
  }

  // —— 补充问：边界保护，防止越界导致“只有题干没有选项”
  if(pendingASuppIndex<0 || pendingASuppIndex>=q.supplements.length){
    pendingASuppIndex=-1;
    return questionCountCheck();
  }
  const s=q.supplements[pendingASuppIndex];
  titleDiv.html(stripLeadingId(s.text));
  const opts = (s.options||[]).map(opt=>{
    return (typeof opt==='object')
      ? {label:opt.label, on:()=>onASupp(q,s,opt)}
      : {label:String(opt), on:()=>onASupp(q,s,opt)};
  });
  renderOptions(opts,1);
}
function onAMain(q,ans){
  recordAnswer(q.id,ans);
  if(ans===YES){ pendingAAnchor=true; } else { aIndex++; }
  clearUI(); renderA();
}
function onAAnchor(q,ans){
  recordAnswer(q.anchorId,ans);
  if(ans===YES){ identityCount++; pendingAAnchor=false; pendingASuppIndex=0; }
  else { pendingAAnchor=false; aIndex++; }
  clearUI(); renderA();
}
function onASupp(q,s,choice){
  const value = (typeof choice==='object' && 'fill' in choice) ? choice.fill : choice;
  recordAnswer(s.id, value);
  pendingASuppIndex++;
  if(pendingASuppIndex>=q.supplements.length){
    pendingASuppIndex=-1;
    return questionCountCheck(); // 命中 A：补充问结束后直接转 D
  }
  clearUI(); renderA();
}

// C1：只有当 A1–A6 主问题全否时触发，然后必进 B
function goC1(){ stage='C1'; clearUI(); titleDiv.html(stripLeadingId(C1.text));
  renderOptions(C1.options.map(opt=>({label:opt,on:()=>{recordAnswer(C1.id,opt); goB();}})),1);
}

// B：只在 A 全否的情况下才会进入；命中一个焦虑原型（补充问完）→ 数量检验
function goB(){ stage='B'; clearUI(); pendingBSuppIndex=-1; renderB(); }
function renderB(){
  const q=B_QUESTIONS[bIndex];
  if(!q){ return questionCountCheck(); }

  if(pendingBSuppIndex===-1){
    titleDiv.html(stripLeadingId(q.main));
    renderOptions([{label:YES,on:()=>onBMain(q,YES)},{label:NO,on:()=>onBMain(q,NO)}],2);
    return;
  }

  if(pendingBSuppIndex<0 || pendingBSuppIndex>=q.supplements.length){
    pendingBSuppIndex=-1; return questionCountCheck();
  }
  const s=q.supplements[pendingBSuppIndex];
  titleDiv.html(stripLeadingId(s.text));
  const opts=(s.options||[]).map(opt=>{
    return (typeof opt==='object')
      ? {label:opt.label, on:()=>onBSupp(q,s,opt)}
      : {label:String(opt), on:()=>onBSupp(q,s,opt)};
  });
  renderOptions(opts,1);
}
function onBMain(q,ans){
  recordAnswer(q.id,ans);
  if(ans===YES){ pendingBSuppIndex=0; } else { bIndex++; }
  clearUI(); renderB();
}
function onBSupp(q,s,choice){
  const value = (typeof choice==='object' && 'fill' in choice) ? choice.fill : choice;
  recordAnswer(s.id, value);
  pendingBSuppIndex++;
  if(pendingBSuppIndex>=q.supplements.length){
    anxietyCount++; pendingBSuppIndex=-1; return questionCountCheck();
  }
  clearUI(); renderB();
}

// D：用于补足到 13 题
let dIndex=0;
function questionCountCheck(){ if(totalAsked>=13) return goDone(); goD(); }
function goD(){
  stage='D'; clearUI();
  const dq=D_QUESTIONS[dIndex % D_QUESTIONS.length];
  titleDiv.html(stripLeadingId(dq.text));
  renderOptions(dq.options.map(opt=>({label:opt,on:()=>{ recordAnswer(dq.id,opt); dIndex++; if(totalAsked>=13) goDone(); else goD(); }})),1);
}

// 完成跳转
function goDone(){
  stage='done'; clearUI();
  titleDiv.html((nameValue||'参与者')+'，谢谢你的回答。');
  const btn=createButton('生成故事'); btn.addClass('btn'); btn.parent(contentDiv); activeButtons.push(btn);
  btn.mousePressed(()=>{
    const payload={ name:nameValue, answers, identityCount, anxietyCount, totalAsked };
    if(USE_LOCAL_STORAGE){ try{ localStorage.setItem('quizPayload', JSON.stringify(payload)); }catch(e){} }
    if(RESULT_URL && RESULT_URL.length>3){ window.location.href = RESULT_URL; }
    else { alert('已收集到 13 题答案。\n提示：还没有设置结果页链接 RESULT_URL；数据已写入 localStorage("quizPayload")。'); }
  });
  setBar();
}

/* —— 纯文字选项渲染：先清空，强制重置类名，避免残留影响 —— */
function renderOptions(list, cols){
  // 移除旧按钮 & 清空容器
  activeButtons.forEach(b=>b.remove()); activeButtons=[];
  contentDiv.html('');
  // 强制重置类名（防止 cols-2 残留）
  contentDiv.elt.className = 'row' + (cols===2 ? ' cols-2' : '');

  // 若 list 异常为空，直接给出一个兜底（防止出现“只有题干没有选项”）
  if(!list || !list.length){
    console.warn('renderOptions: 空选项，兜底为继续');
    const b=createButton('继续'); b.addClass('btn'); b.parent(contentDiv);
    b.mousePressed(()=>{ questionCountCheck(); }); activeButtons.push(b); setBar(); return;
  }

  list.forEach(item=>{
    const label = (typeof item==='object' && 'label' in item) ? item.label : String(item);
    const on = (typeof item==='object' && 'on' in item) ? item.on : null;
    const b=createButton(label);
    b.addClass('btn'); b.parent(contentDiv);
    b.mousePressed(()=>{ on && on(); });
    activeButtons.push(b);
  });
  setBar();
}

/* —— D 题库（原样） —— */
const D_QUESTIONS = [
  { id:'D1', text:'D1. 你更害怕哪一种门？', options:['打不开的门','自己打开的门','一直敲的门']},
  { id:'D2', text:'D2. 哪一种光最让你不安？', options:['闪烁灯管','手机微光','电梯顶灯']},
  { id:'D3', text:'D3. 哪种气味让你想逃离？', options:['潮霉','铁锈','消毒水']},
  { id:'D4', text:'D4. 当房间忽然安静时，你会？', options:['停住不动','立刻说话','打开音乐']},
  { id:'D5', text:'D5. 哪个时间点最不对劲？', options:['03:17','04:44','05:01']},
  { id:'D6', text:'D6. 你最怕哪种脚步？', options:['跟在后面','从门外经过','从楼上停住']},
  { id:'D7', text:'D7. 你会把镜子放在哪里？', options:['窗边','柜门内侧','床对面']},
  { id:'D8', text:'D8. 哪种声音像是专为你而来？', options:['轻轻敲窗','呼喊你的名','电流嗡嗡']},
];
</script>
</body>
</html>
