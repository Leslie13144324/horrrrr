<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>如何被写进恐怖故事里 · 答题页</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.dom.min.js"></script>
  <style>
    :root { --red:#ff3b3b; }
    html,body{margin:0;padding:0;height:100%;background:#000;color:#ffecec;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #sketch-holder{position:fixed;inset:0;z-index:0}
    .vignette{position:fixed;inset:0;pointer-events:none;z-index:2;
      background:radial-gradient(ellipse at center,rgba(0,0,0,0) 35%,rgba(0,0,0,.55) 100%)}
    #ui{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:3;pointer-events:none}

    .card{
      pointer-events:auto;width:min(780px,92vw);
      background:transparent;border:none;padding:20px 0 16px;box-shadow:none;backdrop-filter:none;
    }

    .title{
  font-size:clamp(22px,3.2vw,34px);
  line-height:1.6;
  color:var(--red);              /* 改为红色 */
  margin-bottom:16px;
  text-shadow:0 0 18px rgba(255,59,59,.25); /* 轻微红色光晕，增强可读性 */
}

.btn{
  appearance:none;-webkit-appearance:none;background:transparent;border:none;border-radius:0;
  color:var(--red);              /* 改为红色 */
  padding:6px 2px;text-align:left;cursor:pointer;
  font:inherit;font-size:clamp(18px,2.2vw,24px);line-height:1.5;
  outline:none;transition:opacity .15s ease, transform .06s ease;
  opacity:.96;display:block;text-shadow:0 0 8px rgba(255,59,59,.18);
}
.btn:hover{opacity:1;transform:translateY(-1px)}
.btn:focus-visible{text-decoration:underline;text-underline-offset:3px}


    .input{
      width:100%;background:transparent;color:#fff;border:none;
      border-bottom:1px dashed rgba(255,80,80,.45);padding:8px 4px;outline:none;font-size:18px
    }

    .progress{height:6px;width:100%;background:#171717;border-radius:999px;overflow:hidden;margin:0 0 8px}
    .bar{height:100%;background:var(--red);width:0%;transition:width .25s ease}
  </style>
</head>
<body>
  <div id="sketch-holder"></div>
  <div class="vignette"></div>
  <main id="ui">
    <div class="card">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="title" id="title">请在下方输入你的名字：</div>
      <div class="row" id="content"></div>
    </div>
  </main>

<script>
const RESULT_URL = "./story.html";
const USE_LOCAL_STORAGE = true;

function paramsByProgress(n){
  const t = constrain(n/13, 0, 1), e = t*t*(3-2*t);
  return { amp:lerp(0,60,e), slices:int(lerp(0,48,e)), blocks:int(lerp(0,28,e)),
           scanGap:max(2,int(lerp(8,3,e))), scanAlpha:int(lerp(0,120,e)),
           chroma:int(lerp(0,140,e)), haze:lerp(14,0,e) };
}

const YES='是', NO='否';

/* ---------- A 类题库（女性、性少数、患病者、外地人、东亚家庭被压抑的孩子、社交边缘人） ---------- */
const A_QUESTIONS = [
  { id:'A1', main:'A1. 从小到大，你总被提醒，女孩子要有女孩子的样子', anchorId:'AA1', anchor:'AA1. 你时常感觉做女人无论怎么表现，总有人觉得你不够好',
    supplements:[
      { id:'A1a', text:'A1a. 你照片里的头发，总是', options:[
        { label:'直发',   fill:'她的头发像被刀切过一样整齐，一根不偏，像是贴图而不是长出来的。' },
        { label:'有刘海', fill:'她的刘海像量角器画出来的，一丝不差，像测量用的。' },
        { label:'卷发',   fill:'她看上去像卷发的洋娃娃贴纸一样存在于照片里，背景动，她不动。' },
      ]},
      { id:'A1b', text:'A1b. 你穿的衣服，通常是', options:[
        { label:'你常穿那些不记得什么时候买的衣服，但总能刚刚好搭上。', fill:'她的笑容从来不变，像被印在脸上的，精确得像表盘一样没有误差。' },
        { label:'你每天穿着差不多的搭配，头发也总是差不多的样子。',       fill:'她的头发像早上被放回去的位置，每一根都站队集合。' },
        { label:'你喜欢统一风格，看起来像有一套“自己定制的衣服”。',     fill:'她的衣服像是批量复制的模板，没有褶皱也没有体温。' },
      ]},
      { id:'A1c', text:'A1c. 你在人多的地方时，身体有没有自己动过？', options:[
        { label:'肩膀会先收一下，再把背挺直，像有人在看你。', fill:'她站得太直了，好像有人在身后绑着她的脊柱。' },
        { label:'嘴角会先抿一抿，然后迅速拉成标准的笑。',     fill:'她笑得很快，但像贴了两张一模一样的嘴皮。' },
        { label:'站着的时候脚会平行，膝盖朝前，像排队一样等着发生什么。', fill:'她的腿像摆在展柜里的模特，没有重量，没有动作的权利。' },
      ]},
    ] },

  { id:'A2', main:'A2. 你喜欢的人和父母本来期待的不一样', anchorId:'AA2', anchor:'AA2. 因为“你喜欢谁”这件事，你被明里或暗里说过“该纠正”',
    supplements:[
      { id:'A2a', text:'A2a. 当你路过镜面或玻璃时，你的影子会', options:[
        { label:'比你先行动，总比你早半步转头。', fill:'她的影子像提前收到指令，永远抢先一步。' },
        { label:'出现两层，彼此轻微错位。',           fill:'她有两层影子，像没对齐的印刷。' },
        { label:'与别人的影子短暂叠合，再分开。',     fill:'她的影子像会“试探地贴近别人”，随后迅速退回。' },
      ]},
      { id:'A2b', text:'A2b. 当你听到别人说“正常”的时候，你的身体会', options:[
        { label:'耳边出现收音机失真的嗡鸣。', fill:'耳后像藏着小小的电台，在噪声里呼吸。' },
        { label:'胸口发冷，像被风从里向外吹。',     fill:'胸口僵直，像无法呼吸。' },
        { label:'下意识把手背到身后，像要藏起什么。', fill:'手在身后摸索，像在按一个看不见的开关。' },
      ]},
      { id:'A2c', text:'A2c. 当他们逼你回答“你到底是什么”的时候，你会', options:[
        { label:'只点头或摇头，不说词语。',         fill:'她的嗓子像被薄膜封住，只剩动作在回答。' },
        { label:'笑一下，再反问一个无关紧要的问题。', fill:'她突然大笑，笑声像偏离轨道的指针，指向时间以外的地方。' },
        { label:'把问题重复一遍，像在回声里拖延时间。', fill:'她的回答声却没人听见，声音像回到了她身上，像在她体内绕圈。' },
      ]},
    ] },

  { id:'A3', main:'A3. 你的身体或精神状况，时常让你觉得和健康的人不一样', anchorId:'AA3', anchor:'AA3. 日常的一些小事，对你来说会比别人更麻烦',
    supplements:[
      { id:'A3a', text:'A3a. 早上醒来，你会', options:[
        { label:'先摸一摸枕边的东西。', fill:'时常手在前方不断摸索。' },
        { label:'盯着天花板发一会儿呆。', fill:'眼睛直直对着天花板，像在数裂缝。' },
        { label:'坐起来很快，好像突然被惊动。', fill:'时常像是突然被惊醒了一样，猛地坐起。' },
      ]},
      { id:'A3b', text:'A3b. 你在别人眼中最容易被评价为', options:[
        { label:'“看起来很瘦弱。”', fill:'那人的影子像比本人还窄一圈。' },
        { label:'“有点神经质。”',   fill:'那人的动作像被拉得过紧的线。' },
        { label:'“心思太多。”',     fill:'那人额头总是阴沉，好像压着什么没说完的话。' },
      ]},
      { id:'A3c', text:'A3c. 当你不舒服时，你常会', options:[
        { label:'一个劲儿走来走去。', fill:'那人在楼道里来回，脚步像在磨地板。' },
        { label:'不停写写画画。',     fill:'那人的面前堆着很厚的纸张，满是破碎的符号。' },
        { label:'发呆，直到忘记时间。', fill:'那人坐在那里，像一件没收走的旧物。' },
      ]},
    ] },

  { id:'A4', main:'A4. 你曾经搬离过熟悉的地方，在陌生的城市生活过', anchorId:'AA4', anchor:'AA4. 你住的地方和你成长的家乡差别大',
    supplements:[
      { id:'A4a', text:'A4a. 你的声音总是带着', options:[
        { label:'口音',   fill:'口音里夹杂异乡的腔调。' },
        { label:'奇怪停顿', fill:'那声音是断断续续的。' },
        { label:'过快语速', fill:'语速急促却听不清具体的内容。' },
      ]},
      { id:'A4b', text:'A4b. 你的样子最容易被人记住的地方是', options:[
        { label:'肤色', fill:'那和周围格格不入的皮肤。' },
        { label:'穿着', fill:'那怎么看都不像本地样式的穿着。' },
        { label:'眼神', fill:'那极其飘忽的眼神。' },
      ]},
      { id:'A4c', text:'A4c. 在人群中，你身上散发的气味让人觉得', options:[
        { label:'潮湿', fill:'路途里没干透的雨衣的味道。' },
        { label:'辛辣', fill:'远方辛辣的香料味。' },
        { label:'陌生', fill:'说不出的异味。' },
      ]},
    ] },

  { id:'A5', main:'A5. 你在成长过程中，经常需要压抑自己的真实想法或情绪', anchorId:'AA5', anchor:'AA5. 你是否觉得，在家里你的声音经常被忽视或被打断',
    supplements:[
      { id:'A5a', text:'A5a. 当你试图表达意见时，他们最常对你说', options:[
        { label:'安静',     fill:'安静' },
        { label:'没必要',   fill:'没必要' },
        { label:'别人都这样', fill:'别人都这样' },
      ]},
      { id:'A5b', text:'A5b. 在家中，你最常被要求做到的事情是', options:[
        { label:'听话', fill:'听话' },
        { label:'懂事', fill:'你要懂事' },
        { label:'忍耐', fill:'要学会忍耐' },
      ]},
      { id:'A5c', text:'A5c. 你房间最深的角落里藏着', options:[
        { label:'一堆作业本',   fill:'一本作业本' },
        { label:'一只破旧玩偶', fill:'一只破旧玩偶' },
        { label:'一把锁',       fill:'一把陈旧的锁' },
      ]},
    ] },

  { id:'A6', main:'A6. 你不是在人群里容易被注意到的那类人', anchorId:'AA6', anchor:'AA6. 在社交场合，你总觉得被忽略或无所适从',
    supplements:[
      { id:'A6a', text:'A6a. 如果有人仔细看你的脸，会觉得……', options:[
        { label:'你眨眼很慢',   fill:'眼皮下垂得像要闭上。' },
        { label:'你很爱笑',     fill:'脸上带着僵直的笑。' },
        { label:'你的呼吸很轻', fill:'哪怕走得很近也根本听不到呼吸声。' },
      ]},
      { id:'A6b', text:'A6b. 你学生时期最喜欢坐的位置是', options:[
        { label:'靠窗',   fill:'靠窗' },
        { label:'讲台边', fill:'讲台边' },
        { label:'最后一排', fill:'最后一排' },
      ]},
      { id:'A6c', text:'A6c. 你觉得下面哪项活动最有意思', options:[
        { label:'搓纸片', fill:'在手中把纸一点点搓成小团。' },
        { label:'描字',   fill:'一笔一划在本子上写着什么，把字描得很重。' },
        { label:'观察别人', fill:'直直地盯着人看。' },
      ]},
    ] },
];

/* ---------- C1 兜底判断（沿用） ---------- */
const C1 = { id:'C1', text:'C1. 你最不想遇见',
  options:['中式女鬼','吸血鬼','恶灵'] };

/* ---------- B 类题库（扩充到 B1–B6） ---------- */
const B_QUESTIONS = [
  /* B1 亲密关系焦虑 */
  { id:'B1', main:'B1. 在亲密关系里，你是否始终觉得缺了一点安全感？',
    supplements:[
      { id:'B1a', text:'B1a. 你最常记得你的伴侣身上的气味是', options:[
        { label:'清晨的露水味',       fill:'伴侣身上一直都是清晨的露水味，但最近有一次凑近时，我发现那股清凉里混进酸烂的气息，像尸体泡在湿土里。' },
        { label:'衣服刚烘干的阳光味', fill:'伴侣身上一直都是衣服刚烘干的阳光味，但最近有一次凑近时，我闻到一股焦糊刺鼻的气息，像烧焦的皮肉。' },
        { label:'书页的气息',         fill:'伴侣身上一直都是淡淡的书页气息，但最近有一次凑近时，我嗅到一股潮湿腐霉味，像墨迹溃烂。' },
      ]},
      { id:'B1b', text:'B1b. 你的伴侣最常做的小动作是', options:[
        { label:'抠指甲',   fill:'伴侣坐在床边，手指在黑暗里不停摩擦，反复抠着指甲，指甲屑一点点落下，缝隙里渗出红色的血。' },
        { label:'咳嗽',     fill:'伴侣坐在床边，身体微微前倾，轻轻咳嗽，喉咙里的声音像有什么湿滑的东西在爬动。' },
        { label:'盯着我看', fill:'伴侣坐在床边，眼睛一眨不眨地盯着我，呼吸浅得几乎听不见，像在等我眨眼时爬进来。' },
      ]},
      { id:'B1c', text:'B1c. 你的伴侣房间里最显眼的一样东西是', options:[
        { label:'一面镜子',   fill:'床边摆的镜子里似乎有什么东西一闪而过。' },
        { label:'一只旧水杯', fill:'床头放的水杯里水面轻轻荡漾着，浑浊的颜色像氧化过的血。' },
        { label:'一盏小台灯', fill:'床角的一盏小台灯亮着，灯光闪烁不定。' },
      ]},
    ] },

  /* B2 侵阈焦虑 */
  { id:'B2', main:'B2. 在生活里，你是否有时会觉得有些陌生的存在，正在悄悄靠近你？',
    supplements:[
      { id:'B2a', text:'B2a. 你更容易注意到哪种声音？', options:[
        { label:'拖鞋拖在地上的声音', fill:'那声音很轻，像拖鞋在粗糙地面来回摩擦。' },
        { label:'压抑着的咳嗽',       fill:'那声音断断续续，像咳嗽被硬生生憋住。' },
        { label:'低声念字',           fill:'那声音模糊不清，像有人反复低声念着相同的字。' },
      ]},
      { id:'B2b', text:'B2b. 如果你突然看见一个人，你最先注意到', options:[
        { label:'衣角', fill:'她垂下的衣角，沾着潮湿的泥点。' },
        { label:'手背', fill:'她苍白的手背，上面布满细密的划痕。' },
        { label:'鞋子', fill:'她的一双鞋，鞋底磨得破烂，边缘卷起。' },
      ]},
      { id:'B2c', text:'B2c. 哪种气味最让你难以忽视？', options:[
        { label:'生铁味', fill:'像带着生铁的腥气，仿佛血在金属里凝固。' },
        { label:'湿泥味', fill:'像刚翻开的土堆里潮湿的泥味。' },
        { label:'焦糊味', fill:'像肉烤焦糊之后的气息，刺得眼睛直流泪。' },
      ]},
    ] },

  /* B3 被监视的焦虑 */
  { id:'B3', main:'B3. 你是否会害怕有一双眼睛在你看不到的地方盯着你？',
    supplements:[
      { id:'B3a', text:'B3a. 你最常感觉被注视的地方是', options:[
        { label:'窗户外',   fill:'窗外的玻璃上总映着一个陌生的影子，可我独居，影子却和我的动作对不上。' },
        { label:'天花板',   fill:'灯口的黑洞里总有东西在转动，像一只眼珠缓缓追随我的步伐。' },
        { label:'衣柜里',   fill:'半掩的柜门缝隙里总传来呼吸声，像是谁屏住气体等待我靠近。' },
      ]},
      { id:'B3b', text:'B3b. 你最常感到注视来自于', options:[
        { label:'墙壁', fill:'墙上的裂缝在颤动，像有人正贴在另一边盯着我。' },
        { label:'门缝', fill:'门缝里好像有什么东西在闪动，像人的眼睛。' },
        { label:'窗帘', fill:'窗帘轻轻鼓起，像有什么人影刚刚躲到后面。' },
      ]},
      { id:'B3c', text:'B3c. 你最不敢靠近的物件是', options:[
        { label:'监控摄像头', fill:'角落里的摄像头红点一闪一灭。' },
        { label:'黑屏电视',   fill:'电视屏幕全黑。' },
        { label:'落地镜',     fill:'镜子里的我一动不动。' },
      ]},
    ] },

  /* B4 媒介与科技恐惧 */
  { id:'B4', main:'B4. 科技正在入侵我们的生活。',
    supplements:[
      { id:'B4a', text:'B4a. 当你翻看照片时，你最害怕看见', options:[
        { label:'一扇本不存在的门',           fill:'视频里墙上多出了一扇门，像是通往别的地方。' },
        { label:'桌上多出一件从没摆过的东西', fill:'视频里的书桌上放着一个陌生的电脑，而现实里从没有。' },
        { label:'被删掉的照片自己回来',       fill:'那是一段早就被自己删掉的视频。' },
      ]},
      { id:'B4b', text:'B4b. 当你播放视频时，你最恐惧发现', options:[
        { label:'进度条没有尽头',     fill:'视频的进度条不断延长，像是永远也播不完。' },
        { label:'出现了你没拍过的角度', fill:'画面切换成从天花板往下俯拍的视角，好像有人在上面盯着。' },
        { label:'所有视频都连到同一段', fill:'接着出现了从未见过的陌生片段。' },
      ]},
      { id:'B4c', text:'B4c. 当你关掉手机时，你最害怕察觉到', options:[
        { label:'声音仍在继续', fill:'手机熄灭后，视频的笑声依旧在空气里回荡。' },
        { label:'机身自己在震动', fill:'掌心还能感到一阵阵震动。' },
        { label:'有人在低语',     fill:'手机里响起一阵阵低语，好像是从机身里传出来的。' },
      ]},
    ] },

  /* B5 集体失控与秩序瓦解 */
  { id:'B5', main:'B5. 你害怕那一天到来：街道依旧存在，但所有人都不再按常理行动。',
    supplements:[
      { id:'B5a', text:'B5a. 你最害怕看见', options:[
        { label:'所有人同时做同一个动作', fill:'整排工位的人突然同时抬手扶眼镜，动作整齐得像排练过。' },
        { label:'所有人盯着同一个地方',   fill:'打字声停住，几十双眼睛齐刷刷看向会议室的门口。' },
        { label:'所有人默契地重复一句话', fill:'茶水间里传来一阵啪嗒声，整层楼的人全都在轻轻敲动笔杆，节奏完全一致。' },
      ]},
      { id:'B5b', text:'B5b. 如果你的办公室变得不正常，最有可能发生的是', options:[
        { label:'工作流程失效',   fill:'打印机吐出成堆的白纸，发出巨大的轰鸣声，却好像没人在意。' },
        { label:'职位等级失效',   fill:'经理呆呆站在工位中间一动不动，可没有人看他一眼，所有人自顾自低头写字。' },
        { label:'交流方式失效',   fill:'身旁的同事在交谈，可发出的却是一阵阵杂乱的噪音，像收音机被人打乱了频道。' },
      ]},
      { id:'B5c', text:'B5c. 什么声音最毛骨悚然', options:[
        { label:'整齐的声响', fill:'所有人同时站起来，喉咙里挤出低沉的嘶嘶声，整齐得像在回应某个看不见的指令。' },
        { label:'没来由的大笑', fill:'一阵死寂后，所有人突然放声大笑，笑声尖锐刺耳，在隔间里炸开。' },
        { label:'齐声低语',   fill:'所有人都站了起来，嘴唇一齐开合，吐出相同的低语，嗡嗡声在办公室里回荡。' },
      ]},
    ] },

  /* B6 被替代的恐惧 */
  { id:'B6', main:'B6. 你是否害怕，有一天自己存在过的痕迹会消失？',
    supplements:[
      { id:'B6a', text:'B6a. 在朋友中，你最亮眼的优点是', options:[
        { label:'幽默', fill:'总能说出让气氛轻松的话。' },
        { label:'体贴', fill:'总会注意到别人没说出口的细节。' },
        { label:'倾听', fill:'愿意倾听所有人的烦恼。' },
      ]},
      { id:'B6b', text:'B6b. 别人最容易和你混淆的外貌特征是', options:[
        { label:'眼睛', fill:'连说话时的神色都一模一样。' },
        { label:'发型', fill:'连发型如出一辙。' },
        { label:'笑容', fill:'甚至笑起来时嘴角的弧度都一模一样。' },
      ]},
      { id:'B6c', text:'B6c. 当你开始怀疑世界是否需要你时，你最恐惧看见', options:[
        { label:'另一个人开口就是你的声音', fill:'下一秒那个人抬起头，说出的声音竟然和她一模一样。' },
        { label:'另一个人占据了你的影子',   fill:'她低头时发现自己的脚下竟然没有影子。' },
        { label:'另一个人回应了你的名字',   fill:'大家喊着她的名字，可却是那个人代为回答，没有人觉得有丝毫异样。' },
      ]},
    ] },
];

/* ---------- 画布/特效（原样） ---------- */
let video, pg, camReady=false;
let totalAsked=0, contentDiv,titleDiv,barDiv;

function setup(){
  const holder=document.getElementById('sketch-holder');
  createCanvas(window.innerWidth, window.innerHeight).parent(holder);
  pixelDensity(1); pg=createGraphics(width,height);

  try{
    video=createCapture({video:true,audio:false}, ()=>{camReady=true;});
    video.size(640,480); video.hide();
  }catch(e){ camReady=false; }

  contentDiv = select('#content');
  titleDiv = select('#title');
  barDiv = select('#bar');

  renderIntro();
}

function windowResized(){ resizeCanvas(window.innerWidth, window.innerHeight); pg=createGraphics(width,height); }

function draw(){
  if(camReady && video){
    pg.push(); pg.clear(); pg.translate(pg.width,0); pg.scale(-1,1);
    const w=pg.width,h=pg.height,vw=video.width,vh=video.height; const s=max(w/vw,h/vh); const dw=vw*s, dh=vh*s;
    pg.image(video,(w-dw)/2,(h-dh)/2,dw,dh); pg.pop();

    const p = paramsByProgress(totalAsked);
    if (p.haze > 0) { pg.filter(BLUR, p.haze/12); pg.fill(255, 20); pg.noStroke(); pg.rect(0,0,pg.width,pg.height); }

    applyGlitchProgressive(pg, p); image(pg,0,0,width,height);

    if (p.chroma > 0){
      const off = int(map(noise(millis()*0.004), 0, 1, -p.amp/2.5, p.amp/2.5));
      blendMode(ADD);
      tint(255,60,60, p.chroma); image(pg,  off, 0);
      tint(60,255,60, p.chroma); image(pg, -off, 0);
      tint(60,60,255, p.chroma); image(pg,   0, off/2);
      noTint(); blendMode(BLEND);
    }
  }else{
    const g = drawingContext.createLinearGradient(0,0,width,height); g.addColorStop(0,'#0b0b0b'); g.addColorStop(1,'#1a0c0c');
    drawingContext.fillStyle=g; noStroke(); rect(0,0,width,height);
    noFill(); stroke(255,12); for(let i=0;i<height;i+=22) line(0,i,width,i);
  }
}

function applyGlitchProgressive(g, p){
  const t = millis()*0.001;
  for(let i=0;i<p.slices;i++){
    const sh=int(random(6,24)); const y=int(random(0,g.height-sh));
    const dx=int(map(noise(t*3+i*.17),0,1,-p.amp,p.amp));
    g.copy(g,0,y,g.width,sh, dx,y,g.width,sh);
  }
  for(let i=0;i<p.blocks;i++){
    const bw=int(random(40,160)), bh=int(random(14,60));
    const sx=int(random(0,g.width-bw)), sy=int(random(0,g.height-bh));
    const dx=int(sx + map(noise(t*2.4+i*.31),0,1,-p.amp,p.amp));
    const dy=int(sy + map(noise(t*2.7+i*.37),0,1,-p.amp*.6,p.amp*.6));
    g.copy(g,sx,sy,bw,bh, dx,dy,bw,bh);
  }
  if (p.scanAlpha>0){ g.noStroke(); g.fill(255,p.scanAlpha); const gap=p.scanGap; const off=int((sin(t*5.2)*.5+.5)*gap);
    for(let y=off; y<g.height; y+=gap){ if (y%(gap*2)===0) g.rect(0,y,g.width,2); } }
}

/* ---------- 问卷逻辑（原样） ---------- */
let stage='intro', nameValue='';
let aIndex=0, pendingAAnchor=false, pendingASuppIndex=-1;
let bIndex=0, pendingBSuppIndex=-1;
let identityCount=0, anxietyCount=0;
const answers={};

let activeButtons=[]; let inputEl, startBtn;

function stripLeadingId(s){ return String(s).replace(/^[A-Z]{1,2}\d+[a-z]?\.?\s*/,''); }

function clearUI(){
  activeButtons.forEach(b=>b.remove());
  activeButtons=[];
  if(inputEl){inputEl.remove();inputEl=null;}
  if(startBtn){startBtn.remove();startBtn=null;}
}
function setBar(){ const pct=Math.min(100, Math.round((totalAsked/13)*100)); barDiv.elt.style.width=pct+'%'; }
function recordAnswer(qid,val){ answers[qid]=val; totalAsked++; setBar(); }

/* Intro */
function renderIntro(){
  stage='intro'; titleDiv.html('请在下方输入你的名字：'); clearUI();
  contentDiv.elt.className='row cols-2';
  inputEl=createInput(''); inputEl.addClass('input'); inputEl.parent(contentDiv);
  startBtn=createButton('开始答题'); startBtn.addClass('btn'); startBtn.parent(contentDiv); activeButtons.push(startBtn);
  startBtn.mousePressed(()=>{
    const v=inputEl.value().trim(); if(!v) return;
    nameValue=v; contentDiv.elt.className='row'; goA();
  });
  setBar();
}

/* A 流程：命中一个身份原型（主→锚→补充）后直接进入 D；A 全否 → C1 → B */
function goA(){ stage='A'; clearUI(); pendingAAnchor=false; pendingASuppIndex=-1; renderA(); }
function renderA(){
  const q=A_QUESTIONS[aIndex];
  if(!q){ return goC1(); }

  if(!pendingAAnchor && pendingASuppIndex===-1){
    titleDiv.html(stripLeadingId(q.main));
    renderOptions([{label:YES,on:()=>onAMain(q,YES)},{label:NO,on:()=>onAMain(q,NO)}],2);
    return;
  }
  if(pendingAAnchor && pendingASuppIndex===-1){
    titleDiv.html(stripLeadingId(q.anchor));
    renderOptions([{label:YES,on:()=>onAAnchor(q,YES)},{label:NO,on:()=>onAAnchor(q,NO)}],2);
    return;
  }

  if(pendingASuppIndex<0 || pendingASuppIndex>=q.supplements.length){
    pendingASuppIndex=-1;
    return questionCountCheck();
  }
  const s=q.supplements[pendingASuppIndex];
  titleDiv.html(stripLeadingId(s.text));
  const opts = (s.options||[]).map(opt=>{
    return (typeof opt==='object')
      ? {label:opt.label, on:()=>onASupp(q,s,opt)}
      : {label:String(opt), on:()=>onASupp(q,s,opt)};
  });
  renderOptions(opts,1);
}
function onAMain(q,ans){
  recordAnswer(q.id,ans);
  if(ans===YES){ pendingAAnchor=true; } else { aIndex++; }
  clearUI(); renderA();
}
function onAAnchor(q,ans){
  recordAnswer(q.anchorId,ans);
  if(ans===YES){ identityCount++; pendingAAnchor=false; pendingASuppIndex=0; }
  else { pendingAAnchor=false; aIndex++; }
  clearUI(); renderA();
}
function onASupp(q,s,choice){
  const value = (typeof choice==='object' && 'fill' in choice) ? choice.fill : choice;
  recordAnswer(s.id, value);
  pendingASuppIndex++;
  if(pendingASuppIndex>=q.supplements.length){
    pendingASuppIndex=-1;
    return questionCountCheck();
  }
  clearUI(); renderA();
}

/* C1：A 主问题全否时触发，然后必进 B */
function goC1(){ stage='C1'; clearUI(); titleDiv.html(stripLeadingId(C1.text));
  renderOptions(C1.options.map(opt=>({label:opt,on:()=>{recordAnswer(C1.id,opt); goB();}})),1);
}

/* B 流程：只会命中一个焦虑原型（主→补充） */
function goB(){ stage='B'; clearUI(); pendingBSuppIndex=-1; renderB(); }
function renderB(){
  const q=B_QUESTIONS[bIndex];
  if(!q){ return questionCountCheck(); }

  if(pendingBSuppIndex===-1){
    titleDiv.html(stripLeadingId(q.main));
    renderOptions([{label:YES,on:()=>onBMain(q,YES)},{label:NO,on:()=>onBMain(q,NO)}],2);
    return;
  }

  if(pendingBSuppIndex<0 || pendingBSuppIndex>=q.supplements.length){
    pendingBSuppIndex=-1; return questionCountCheck();
  }
  const s=q.supplements[pendingBSuppIndex];
  titleDiv.html(stripLeadingId(s.text));
  const opts=(s.options||[]).map(opt=>{
    return (typeof opt==='object')
      ? {label:opt.label, on:()=>onBSupp(q,s,opt)}
      : {label:String(opt), on:()=>onBSupp(q,s,opt)};
  });
  renderOptions(opts,1);
}
function onBMain(q,ans){
  recordAnswer(q.id,ans);
  if(ans===YES){ pendingBSuppIndex=0; } else { bIndex++; }
  clearUI(); renderB();
}
function onBSupp(q,s,choice){
  const value = (typeof choice==='object' && 'fill' in choice) ? choice.fill : choice;
  recordAnswer(s.id, value);
  pendingBSuppIndex++;
  if(pendingBSuppIndex>=q.supplements.length){
    anxietyCount++; pendingBSuppIndex=-1; return questionCountCheck();
  }
  clearUI(); renderB();
}

/* D：用于补足到 13 题（新增“兜底问题：你最害怕？”） */
let dIndex=0;
function questionCountCheck(){ if(totalAsked>=13) return goDone(); goD(); }
function goD(){
  stage='D'; clearUI();
  const dq=D_QUESTIONS[dIndex % D_QUESTIONS.length];
  titleDiv.html(stripLeadingId(dq.text));
  renderOptions(dq.options.map(opt=>({label:opt,on:()=>{ recordAnswer(dq.id,opt); dIndex++; if(totalAsked>=13) goDone(); else goD(); }})),1);
}

/* 完成跳转 */
function goDone(){
  stage='done'; clearUI();
  titleDiv.html((nameValue||'参与者')+'，谢谢你的回答。');
  const btn=createButton('生成故事'); btn.addClass('btn'); btn.parent(contentDiv); activeButtons.push(btn);
  btn.mousePressed(()=>{
    const payload={ name:nameValue, answers, identityCount, anxietyCount, totalAsked };
    if(USE_LOCAL_STORAGE){ try{ localStorage.setItem('quizPayload', JSON.stringify(payload)); }catch(e){} }
    if(RESULT_URL && RESULT_URL.length>3){ window.location.href = RESULT_URL; }
    else { alert('已收集到 13 题答案。\n提示：还没有设置结果页链接 RESULT_URL；数据已写入 localStorage(\"quizPayload\")。'); }
  });
  setBar();
}

/* 选项渲染 */
function renderOptions(list, cols){
  activeButtons.forEach(b=>b.remove()); activeButtons=[];
  contentDiv.html('');
  contentDiv.elt.className = 'row' + (cols===2 ? ' cols-2' : '');
  if(!list || !list.length){
    const b=createButton('继续'); b.addClass('btn'); b.parent(contentDiv);
    b.mousePressed(()=>{ questionCountCheck(); }); activeButtons.push(b); setBar(); return;
  }
  list.forEach(item=>{
    const label = (typeof item==='object' && 'label' in item) ? item.label : String(item);
    const on = (typeof item==='object' && 'on' in item) ? item.on : null;
    const b=createButton(label);
    b.addClass('btn'); b.parent(contentDiv);
    b.mousePressed(()=>{ on && on(); });
    activeButtons.push(b);
  });
  setBar();
}

/* D 题库：原有 8 条 + 兜底问题 */
const D_QUESTIONS = [
  { id:'D1', text:'D1. 你更害怕哪一种门？', options:['打不开的门','自己打开的门','一直敲的门']},
  { id:'D2', text:'D2. 哪一种光最让你不安？', options:['闪烁灯管','手机微光','电梯顶灯']},
  { id:'D3', text:'D3. 哪种气味让你想逃离？', options:['潮霉','铁锈','消毒水']},
  { id:'D4', text:'D4. 当房间忽然安静时，你会？', options:['停住不动','立刻说话','打开音乐']},
  { id:'D5', text:'D5. 哪个时间点最不对劲？', options:['03:17','04:44','05:01']},
  { id:'D6', text:'D6. 你最怕哪种脚步？', options:['跟在后面','从门外经过','从楼上停住']},
  { id:'D7', text:'D7. 你会把镜子放在哪里？', options:['窗边','柜门内侧','床对面']},
  { id:'D8', text:'D8. 哪种声音像是专为你而来？', options:['轻轻敲窗','呼喊你的名','电流嗡嗡']},
];
</script>
</body>
</html>
